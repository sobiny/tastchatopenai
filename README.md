# Midjourney è‡ªåŠ¨åŒ–æ§åˆ¶å° (ThinkPHP 5.0.24)

æœ¬é¡¹ç›®åŸºäº ThinkPHP 5.0.24 æ„å»ºï¼Œæ•´åˆäº† [Midjourney API](https://docs-zh.mjapiapp.com/api/midjourney-api) çš„å›¾åƒç”Ÿæˆã€æ”¾å¤§ã€å˜æ¢ã€Describe ç­‰èƒ½åŠ›ï¼Œå¹¶æä¾›å¼‚æ­¥å›è°ƒä¸æ•°æ®åº“ä»»åŠ¡ç®¡ç†ã€‚

## åŠŸèƒ½æ¦‚è§ˆ

- âœ¨ **å›¾åƒç”ŸæˆåŠŸèƒ½**ï¼šè¾“å…¥ Prompt ä¸€é”®æäº¤ä»»åŠ¡ã€‚
- ğŸ” **æ”¾å¤§ / å˜æ¢**ï¼šé’ˆå¯¹å·²æœ‰ä»»åŠ¡æ‰§è¡Œ Upscale ä¸ Variationã€‚
- ğŸ–¼ï¸ **Describe æ”¯æŒ**ï¼šé€šè¿‡å›¾ç‰‡é“¾æ¥ç”Ÿæˆæ–‡æœ¬æè¿°ã€‚
- ğŸ“¡ **å¼‚æ­¥å›è°ƒ**ï¼šå®ç° `/api/task/callback` å›è°ƒæ¥å£ï¼Œè‡ªåŠ¨æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸å›¾ç‰‡é“¾æ¥ã€‚
- ğŸ“Š **ä»»åŠ¡çœ‹æ¿**ï¼šä½¿ç”¨ Axios å®æ—¶åˆ·æ–°ä»»åŠ¡åˆ—è¡¨ï¼ŒæŸ¥çœ‹è¿›åº¦ã€å¤±è´¥åŸå› ç­‰ã€‚
- ğŸ’¾ **æ•°æ®åº“æŒä¹…åŒ–**ï¼šå†…ç½® `mj_tasks` è¡¨ç»“æ„ä¸ Phinx è¿ç§»è„šæœ¬ï¼Œé»˜è®¤æ”¯æŒ SQLiteã€‚

## å¿«é€Ÿå¼€å§‹

1. **å®‰è£…ä¾èµ–**

   ```bash
   composer install
   ```

2. **å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿å¹¶å¡«å†™**

   ```bash
   cp .env.example .env
   ```

   è¯·åœ¨ `.env` ä¸­é…ç½®ï¼š

   - `midjourney.token`ï¼šMidjourney API Tokenï¼›
   - `midjourney.callback_url`ï¼šå…¬ç½‘å¯è®¿é—®çš„å›è°ƒåœ°å€ï¼ˆä¾‹å¦‚ `https://your-domain.com/api/task/callback`ï¼‰ã€‚è¯¥åœ°å€ä¼šåœ¨æäº¤ä»»åŠ¡æ—¶ä¸€å¹¶å‘é€ç»™ Midjourneyï¼Œç”±å…¶æœåŠ¡å™¨åœ¨ä»»åŠ¡çŠ¶æ€å˜åŒ–æ—¶å›è°ƒï¼›
   - è‹¥éœ€è¦ï¼Œå¯è®¾ç½® `database.database` æŒ‡å‘ MySQL æˆ– SQLite æ–‡ä»¶ã€‚

3. **æ‰§è¡Œæ•°æ®åº“è¿ç§»**ï¼ˆéœ€å®‰è£… `topthink/think-migration` æ’ä»¶ï¼‰

   ```bash
   php think migrate:run
   ```

4. **å¯åŠ¨å†…ç½®å¼€å‘æœåŠ¡å™¨**

   ```bash
   php think run
   ```

   è®¿é—® `http://127.0.0.1:8000` å³å¯ä½¿ç”¨å¯è§†åŒ–æ§åˆ¶å°ã€‚

## ç›®å½•ç»“æ„

```
â”œâ”€â”€ application
â”‚   â”œâ”€â”€ api
â”‚   â”‚   â””â”€â”€ controller
â”‚   â”‚       â””â”€â”€ Midjourney.php        # API æ§åˆ¶å™¨ï¼Œå°è£…ä»»åŠ¡æäº¤ã€å›è°ƒã€æŸ¥è¯¢
â”‚   â”œâ”€â”€ common
â”‚   â”‚   â”œâ”€â”€ model
â”‚   â”‚   â”‚   â””â”€â”€ MjTask.php            # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ service
â”‚   â”‚   â”‚   â””â”€â”€ MidjourneyClient.php  # è°ƒç”¨ Midjourney API çš„å°è£…
â”‚   â”‚   â””â”€â”€ validate
â”‚   â”‚       â””â”€â”€ MjTaskValidate.php    # è¡¨å•æ ¡éªŒ
â”‚   â”œâ”€â”€ index
â”‚   â”‚   â”œâ”€â”€ controller
â”‚   â”‚   â”‚   â””â”€â”€ Index.php             # å¯è§†åŒ–é¡µé¢
â”‚   â”‚   â””â”€â”€ view
â”‚   â”‚       â””â”€â”€ index
â”‚   â”‚           â””â”€â”€ index.html        # å‰ç«¯é¡µé¢æ¨¡æ¿
â”‚   â”œâ”€â”€ config.php                    # å…¨å±€é…ç½®
â”‚   â”œâ”€â”€ database.php                  # æ•°æ®åº“é…ç½®
â”‚   â”œâ”€â”€ route.php                     # è·¯ç”±å®šä¹‰
â”‚   â””â”€â”€ extra
â”‚       â””â”€â”€ midjourney.php            # Midjourney é…ç½®
â”œâ”€â”€ database
â”‚   â””â”€â”€ migrations
â”‚       â””â”€â”€ 20240101000000_create_mj_tasks_table.php
â”œâ”€â”€ public
â”‚   â”œâ”€â”€ index.php                     # å…¥å£æ–‡ä»¶
â”‚   â””â”€â”€ static
â”‚       â”œâ”€â”€ css/app.css
â”‚       â””â”€â”€ js/app.js
â””â”€â”€ composer.json
```

## å›è°ƒç¤ºä¾‹

Midjourney å¹³å°ä¼šåœ¨ä»»åŠ¡çŠ¶æ€å˜åŒ–æ—¶å‘ `/api/task/callback` å‘é€ POST è¯·æ±‚ã€‚ç¤ºä¾‹è½½è·ï¼š

```json
{
  "taskId": "93c9d820-f3f4-4d8a-b2f2-xxxx",
  "status": "SUCCESS",
  "progress": "100%",
  "imageUrl": "https://cdn.mjapiapp.com/.../image.png",
  "failReason": null
}
```

æ§åˆ¶å™¨ä¼šæ ¹æ® `taskId` è‡ªåŠ¨æ›´æ–° `mj_tasks` è¡¨ä¸­çš„çŠ¶æ€ã€è¿›åº¦ã€å›¾ç‰‡åœ°å€åŠå…ƒæ•°æ®ã€‚

## æ³¨æ„äº‹é¡¹

- è‹¥éƒ¨ç½²åœ¨å…¬ç½‘æœåŠ¡å™¨ï¼Œè¯·ç¡®ä¿ `public/` ç›®å½•ä½œä¸º Web Server æ ¹ç›®å½•ã€‚
- è‹¥éœ€è¦ä½¿ç”¨ MySQLï¼Œè¯·å°† `database.php` ä¸­ `type` æ”¹ä¸º `mysql`ï¼Œå¹¶åœ¨ `.env` ä¸­è¡¥å……è¿æ¥ä¿¡æ¯ã€‚
- å»ºè®®ç»“åˆ Redis é˜Ÿåˆ—å®ç°æ›´å¤æ‚çš„ä»»åŠ¡çŠ¶æ€è½®è¯¢ï¼Œå¯æ‰©å±• `MidjourneyClient::fetchTask` æ–¹æ³•ã€‚

æ¬¢è¿æ ¹æ®ä¸šåŠ¡éœ€æ±‚ç»§ç»­æ‰©å±•ï¼Œå¦‚åŠ å…¥ç”¨æˆ·ä½“ç³»ã€ä»»åŠ¡æƒé™æ§åˆ¶ã€Webhook ç­¾åæ ¡éªŒç­‰èƒ½åŠ›ã€‚
